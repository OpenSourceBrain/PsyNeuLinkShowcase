<Lems>


    <ComponentType  name="fnCell"
                    extends="baseCellMembPotDL"
                    description="The Fitzhugh Nagumo model...">

        <Parameter name="a" dimension="none"/>
        <Parameter name="b" dimension="none"/>
        <Parameter name="phi" dimension="none"/>
        <Parameter name="Iext" dimension="none"/>

        <!-- Initial Conditions -->
        <Parameter name="initial_v" dimension="none"/>
        <Parameter name="initial_w" dimension="none"/>

        <Constant name="MSEC" dimension="time" value="1ms"/>
       
        <Attachments name="synapses" type="basePointCurrentDL"/>

        <!-- <Exposure name="V" dimension="none"/> --> <!-- Already exposed from baseCellMembPotDL -->
        <Exposure name="W" dimension="none"/>
        <Exposure name="F" dimension="none"/>
        
        <EventPort name="spike" direction="out" description="Spike event"/>

        <Dynamics>

            <StateVariable name="V" dimension="none" exposure="V"
                           description="V plays the role of the membrane potential"/>
            <StateVariable name="W" dimension="none" exposure="W"
                           description="W plays the role of a recovery variable"/>
            <StateVariable name="spiking" dimension="none"/>

            <!-- F must be a cubic polynomial in V -->
            <DerivedVariable name="F" dimension="none" exposure="F" value="V - (V^3 / 3)"/>

            <DerivedVariable name="ISyn" dimension="none" select="synapses[*]/I" reduce="add" />

            <TimeDerivative variable="V" value="(F - W + Iext + ISyn) / MSEC"/>
            <TimeDerivative variable="W" value="phi * (V + a - b * W) / MSEC"/>

            <OnStart>
                <StateAssignment variable="V" value="initial_v"/>
                <StateAssignment variable="W" value="initial_w"/>
                <StateAssignment variable="spiking" value="0"/>
            </OnStart>

            <OnCondition test="V .gt. 0 .and. spiking .lt. 0.5">
                <StateAssignment variable="spiking" value="1"/>
                <EventOut port="spike"/>
            </OnCondition>
            
            <OnCondition test="V .lt. 0">
                <StateAssignment variable="spiking" value="0"/>
            </OnCondition>
            
            
        </Dynamics>
    </ComponentType>
    
    <fnCell id="fn" a="0.7" b="0.8" phi="0.08" initial_v="-1" initial_w="0" Iext="1"/>
    

    <ComponentType name="simpleExponentialSynapse"
                   extends="baseSynapseDL"
                   description="Ohmic synapse model whose conductance rises instantaneously by (_gbase * _weight) on receiving an event, and which decays exponentially to zero with time course _tauDecay">

        <Parameter name="tauDecay" dimension="time" description="Time course of decay"/>
        <Parameter name="Gbase" dimension="none" description="Baseline conductance, generally the maximum conductance following a single spike"/>
        <Parameter name="erev" dimension="none" description="Reversal potential of the synapse"/>
        
        <Requirement name="V" dimension="none" description="The current may vary with the voltage exposed by the ComponentType on which this is placed"/>

        <Exposure name="G" dimension="none"/>
        
        <EventPort name="in" direction="in"/>
        
        <Dynamics>

            <StateVariable name="G" dimension="none" exposure="G"/>

            <DerivedVariable name="I" exposure="I" dimension="none" value="G * (erev - V)" />

            <TimeDerivative variable="G" value="-G / tauDecay" />

            <OnStart>
                <StateAssignment variable="G" value="0" />
            </OnStart>

            <OnEvent port="in">
                <StateAssignment variable="G" value="G + Gbase" />
            </OnEvent>

        </Dynamics>
    </ComponentType>

    
</Lems>